{% extends "base.html" %}

{% block title %}–§–∏–ª—å–º—ã - Cinema{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-film"></i> –ö–∞—Ç–∞–ª–æ–≥ —Ñ–∏–ª—å–º–æ–≤</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMovieModal">
        <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å–º
    </button>
</div>

<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <input type="text" class="form-control" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é...">
            </div>
            <div class="col-md-3">
                <select class="form-select" id="genreFilter">
                    <option value="">–í—Å–µ –∂–∞–Ω—Ä—ã</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="sortBy">
                    <option value="title">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
                    <option value="rating">–ü–æ —Ä–µ–π—Ç–∏–Ω–≥—É</option>
                    <option value="release_date">–ü–æ –¥–∞—Ç–µ –≤—ã—Ö–æ–¥–∞</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-secondary w-100" onclick="loadMovies()">
                    <i class="bi bi-arrow-clockwise"></i> –û–±–Ω–æ–≤–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<div id="moviesContainer" class="row">
    <div class="col-12 text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
    </div>
</div>

<script>
let allMovies = [];

async function loadMovies() {
    try {
        const response = await axios.get('/movies/');
        allMovies = response.data;
        displayMovies(allMovies);
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å–º–æ–≤:', error);
        document.getElementById('moviesContainer').innerHTML = `
            <div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å–º–æ–≤</div>
        `;
    }
}

function displayMovies(movies) {
    const container = document.getElementById('moviesContainer');

    if (movies.length === 0) {
        container.innerHTML = '<div class="col-12"><p class="text-center">–§–∏–ª—å–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p></div>';
        return;
    }

    const html = movies.map(movie => `
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">${movie.title}</h5>
                    <p class="card-text text-muted">${movie.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                    <div class="mb-2">
                        <span class="badge bg-primary">‚≠ê ${movie.rating || 'N/A'}</span>
                        <span class="badge bg-secondary">üïê ${movie.duration || 'N/A'}</span>
                    </div>
                    <small class="text-muted">–î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞: ${movie.release_date || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</small>
                </div>
                <div class="card-footer">
                    <button class="btn btn-sm btn-info" onclick="viewMovie(${movie.id})">
                        <i class="bi bi-eye"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="editMovie(${movie.id})">
                        <i class="bi bi-pencil"></i> –ò–∑–º–µ–Ω–∏—Ç—å
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteMovie(${movie.id})">
                        <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    `).join('');

    container.innerHTML = html;
}

function viewMovie(id) {
    window.location.href = `/ui/movies/${id}`;
}

async function deleteMovie(id) {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∏–ª—å–º?')) {
        try {
            await axios.delete(`/movies/${id}`);
            alert('–§–∏–ª—å–º —É–¥–∞–ª–µ–Ω!');
            loadMovies();
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∏–ª—å–º–∞');
        }
    }
}

// –ü–æ–∏—Å–∫
document.getElementById('searchInput').addEventListener('input', function(e) {
    const search = e.target.value.toLowerCase();
    const filtered = allMovies.filter(m =>
        m.title.toLowerCase().includes(search)
    );
    displayMovies(filtered);
});

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', loadMovies);
</script>
{% endblock %}